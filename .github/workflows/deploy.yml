name: ğŸš€ Gemini Automation Deploy & Run

on:
  workflow_dispatch:
    inputs:
      session_count:
        description: 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑÑĞ¸Ğ¹'
        required: false
        default: '5'
      task_prompt:
        description: 'Ğ¢ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ°'
        required: false
        default: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ°ĞºÑ†Ğ¸Ñ NVIDIA?'

jobs:
  run-automation:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
    
    steps:
      - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
        uses: actions/checkout@v4

      - name: ğŸ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
        run: |
          pip install --upgrade pip
          pip install fastapi uvicorn playwright pydantic pydantic-settings
          playwright install chromium

      - name: ğŸ¯ Ğ—Ğ°Ğ¿ÑƒÑĞº Gemini Automation
        run: |
          python -c "
import asyncio
import json
from datetime import datetime
from gemini_automation_extended import GeminiAutomationManager, Task
import uuid

async def main():
    print('ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Gemini Automation Ğ½Ğ° GitHub Actions')
    print('=' * 80)
    
    manager = GeminiAutomationManager()
    await manager.init_browser()
    
    try:
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ
        task_id = str(uuid.uuid4())[:8]
        session_count = int('${{ github.event.inputs.session_count }}') or 5
        task_prompt = '''${{ github.event.inputs.task_prompt }}''' or 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ°ĞºÑ†Ğ¸Ñ NVIDIA?'
        
        print(f'ğŸ“‹ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸:')
        print(f'  Task ID: {task_id}')
        print(f'  Sessions: {session_count}')
        print(f'  Prompt: {task_prompt}')
        print('=' * 80)
        
        task = Task(
            id=task_id,
            prompt=task_prompt,
            session_count=session_count
        )
        
        manager.tasks[task_id] = task
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ
        await manager.run_task(task)
        
        # Ğ–Ğ´ĞµĞ¼, Ğ¿Ğ¾ĞºĞ° Ğ²ÑĞµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑÑ
        print(f'â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ...')
        while task.active_sessions > 0:
            await asyncio.sleep(5)
            print(f'  Active: {task.active_sessions}, Completed: {task.completed_sessions}, Failed: {task.failed_sessions}')
        
        # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
        task.save_to_file()
        
        print('=' * 80)
        print(f'âœ… Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!')
        print(f'  Total Sessions: {session_count}')
        print(f'  Completed: {task.completed_sessions}')
        print(f'  Failed: {task.failed_sessions}')
        print(f'  Results saved to: results/{task_id}/')
        
    finally:
        await manager.close_browser()

asyncio.run(main())
"

      - name: ğŸ“¸ ĞÑ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
        if: always()
        run: |
          if [ -d "results" ]; then
            echo "ğŸ“¦ ĞÑ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²..."
            tar -czf results.tar.gz results/ || true
            ls -lah results/ || echo "ĞŸĞ°Ğ¿ĞºĞ° results Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
          else
            echo "âš ï¸ ĞŸĞ°Ğ¿ĞºĞ° results Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
          fi

      - name: ğŸ“¤ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gemini-results
          path: |
            results/
            gemini_automation.log
            results.tar.gz
          retention-days: 7

      - name: ğŸ“Š Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
        if: always()
        run: |
          echo "ğŸ‰ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« Ğ—ĞĞŸĞ£Ğ¡ĞšĞ"
          echo "===================="
          
          if [ -f "gemini_automation.log" ]; then
            echo ""
            echo "ğŸ“‹ Ğ›Ğ¾Ğ³Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:"
            echo "===================="
            tail -100 gemini_automation.log
          fi
          
          if [ -d "results" ]; then
            echo ""
            echo "ğŸ“‚ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²:"
            echo "===================="
            find results -type f -name "*.txt" -o -name "*.json" -o -name "*.png" | head -20
            
            echo ""
            echo "ğŸ“ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ»Ğ¾Ğ³Ğ¾Ğ² ÑĞµÑÑĞ¸Ğ¹:"
            echo "===================="
            find results -name "00_session_logs.txt" -print0 | head -3 | xargs -0 head -30 2>/dev/null || echo "Ğ›Ğ¾Ğ³Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
          fi

      - name: ğŸ”” Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ‰ Gemini Automation - GitHub Actions Run
          
          ## Run Details
          - **Timestamp**: $(date)
          - **Session Count**: ${{ github.event.inputs.session_count || 5 }}
          - **Prompt**: "${{ github.event.inputs.task_prompt }}"
          
          ## ğŸ“ Artifacts
          Ğ’ÑĞµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² **Artifacts**:
          - ğŸ“¸ Ğ¡ĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ñ‹ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑˆĞ°Ğ³Ğ°
          - ğŸ“‹ Ğ›Ğ¾Ğ³Ğ¸ ÑĞµÑÑĞ¸Ğ¹ (Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚)
          - ğŸ“„ HTML ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†
          - ğŸ“Š JSON Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
          - ğŸ“‘ gemini_automation.log
          
          ## ğŸ” ĞšĞ°Ğº Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
          
          1. ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ **Artifacts** ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          2. Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ `gemini-results` Ğ°Ñ€Ñ…Ğ¸Ğ²
          3. Ğ Ğ°ÑĞ¿Ğ°ĞºÑƒĞ¹Ñ‚Ğµ Ğ¸ Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ:
             - `results/<task-id>/screenshots/<session-id>/` - ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ñ‹
             - `results/<task-id>/screenshots/<session-id>/00_session_logs.txt` - Ğ»Ğ¾Ğ³Ğ¸
             - `gemini_automation.log` - Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸
          
          ## ğŸ“Š Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
          ```
          results/
          â”œâ”€â”€ <task-id>/
          â”‚   â”œâ”€â”€ <task-id>_results.json    (Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹)
          â”‚   â””â”€â”€ screenshots/
          â”‚       â”œâ”€â”€ <session-1>/
          â”‚       â”‚   â”œâ”€â”€ 00_session_logs.txt
          â”‚       â”‚   â”œâ”€â”€ 01_page_loaded.png
          â”‚       â”‚   â”œâ”€â”€ 02_text_entered.png
          â”‚       â”‚   â””â”€â”€ page_content.html
          â”‚       â”œâ”€â”€ <session-2>/
          â”‚       â””â”€â”€ ...
          gemini_automation.log            (Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸)
          ```
          EOF

  publish-results:
    runs-on: ubuntu-latest
    needs: run-automation
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´ Ğ´Ğ»Ñ push
        uses: actions/checkout@v4

      - name: ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ artifacts
        uses: actions/download-artifact@v3
        with:
          name: gemini-results
          path: ./artifacts

      - name: ğŸ“ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
        continue-on-error: true
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if [ -d "artifacts/results" ]; then
            rm -rf results || true
            mv artifacts/results . || true
          fi
          
          if [ -f "artifacts/gemini_automation.log" ]; then
            cp artifacts/gemini_automation.log . || true
          fi
          
          git add -A results/ gemini_automation.log 2>/dev/null || true
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ¤– Auto: Gemini automation results from GitHub Actions [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push origin master || echo "Push skipped"
          else
            echo "No changes to commit"
          fi

  upload-summary:
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ÑĞ¼Ğµ
        run: |
          cat << 'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  âœ… GEMINI AUTOMATION - GITHUB ACTIONS COMPLETE          â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                          â•‘
          â•‘  ğŸ“¸ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² Artifacts            â•‘
          â•‘  ğŸ“‹ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ²: gemini_automation.log                â•‘
          â•‘  ğŸ“ Ğ¡ĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ñ‹ Ğ²: results/<task-id>/screenshots/         â•‘
          â•‘  ğŸ“Š JSON Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹: results/<task-id>_results.json     â•‘
          â•‘                                                          â•‘
          â•‘  ğŸ”— Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ artifacts Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°            â•‘
          â•‘  ğŸ“– Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ: https://github.com/.../blob/master/   â•‘
          â•‘                                                          â•‘
          â•‘  Workflow: https://github.com/${{ github.repository }}/  â•‘
          â•‘            actions/runs/${{ github.run_id }}             â•‘
          â•‘                                                          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EOF
